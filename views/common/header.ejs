<% const isLoggedIn = typeof loggedIn === 'undefined' ? false : loggedIn %>
<% const isMain = typeof mainPage === 'undefined' ? false : mainPage %>
<% const hasError = typeof error === 'undefined' ? false : !!error %>

<script src="/javascript/utils.js"></script>

<% if(hasError && error.code === "001" && !loggedIn){ %>   
    <div class="login-failed">
        <h1>Error: Login failed, please try again.</h1>
    </div>
    <% } %>
    <div class="head-image <%= isMain ? 'main' : '' %>">
        <div class="navbar-container">
            <div class="logo-image mobile-only"><img src="/images/logo.svg" width="160px"></div>
            <div class="navbar-vertical-spacing">
                <div class="navbar">
                    <% if(!isMain){ %>
                    <a href="/" id="home">Home</a>
                    <% } %>
                    <% if(isLoggedIn){ %>
                    <a href="/bets/play" id="play">Play Super 6</a>
                    <a href="/profile"><%= `${user.firstName} ${user.surname}` %></a>
                    <a href="/users/logout">Logout</a>
                    <%} else {%>
                    <a class="mobile-only" href="#" onclick="showUserForm('login')" id="play">Login</a>
                    <a class="mobile-only" href="#" onclick="showUserForm('register')" id="play">Register</a>
                    <%}%>
                </div>
            </div>
            <div class="logo-image desktop-only"><img src="/images/logo.svg" width="160px"></div>
        </div>
        <div class="head-grad desktop-only">
            <% if(!isLoggedIn && isMain){ %>
                <button class="open-button" onclick="showUserForm('login')">LOGIN</button>
                <button class="open-button button-margin-bottom" onclick="showUserForm('register')">REGISTER</button>
                <%}%>

        </div>
        <% include loginForm.ejs %>
        <% include userForm.ejs %>
    </div>

    <script>
        // Need to move all this into a javascript file

        var colourBadFields = function(inputElement) {
            inputElement.style = "background:red;"; // We need to turn this into a class
        };
        
        var loginError = function(httpStatusCode, responseText, responseJson){
            if(responseJson) {
                for(var i=0; i<responseJson.errors.length; i++){
                    var elementName = responseJson.errors[i].param;
                    colourBadFields(formElement.querySelector("[name='"+ elementName +"']"));
                }
            }
        };

        var submitUserInfo = function(formId, endpoint) {
            var formElement = document.querySelector("#"+formId);
            var allInputFields = formElement.querySelectorAll("input");
            var formValues = {};
            var hasErrors = false;
            for(var i=allInputFields.length-1; i >= 0; i--){
                formValues[allInputFields[i].getAttribute("name")] = allInputFields[i].value;
                if(!allInputFields[i].checkValidity()){
                    allInputFields[i].reportValidity();
                    hasErrors = true;
                    colourBadFields(allInputFields[i]);
                }
            }
            
            if(hasErrors){
                return false;
            }

            makeRequest(endpoint,
                "POST",
                function() {
                    location.href = "/bets/play";
                },
                loginError,
                formValues
            );
        };

        var showUserForm = function (type) {
            // The code below should just decide which login form to open
            if (type === 'login') {
                document.querySelector("[login_form]").classList.add("show-form");
            } else if (type === 'register') {
                document.querySelector("[user_form]").classList.add("show-form");
            }
        };

        var closeUserForm = function () {
            document.querySelector("[user_form].show-form,[login_form].show-form ").classList.remove("show-form");
        };
    </script>
